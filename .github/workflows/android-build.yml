name: Build Android APK (Even If Failed)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10 (Áªü‰∏ÄÁâàÊú¨)
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y git zip unzip openjdk-17-jdk python3-pip \
          autoconf automake libtool pkg-config libgmp3-dev libmpfr-dev libmpc-dev \
          libssl-dev libncurses5-dev libncursesw5-dev libtinfo6 libltdl-dev

    - name: Clean previous builds
      run: |
        echo "Cleaning previous build artifacts..."
        rm -rf ~/.buildozer/android/platform/python-for-android
        rm -rf ~/.buildozer/android/platform/build-armeabi-v7a
        rm -rf bin/
        mkdir -p bin

    - name: Install Buildozer and dependencies
      run: |
        python -m pip install --upgrade pip setuptools
        pip install cython==0.29.36
        pip install buildozer==1.5.0
        pip install python-for-android==2024.01.21

    - name: Cache Buildozer global directory
      uses: actions/cache@v4
      with:
        path: ~/.buildozer
        key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          buildozer-${{ runner.os }}-

    - name: Install Android NDK r25c
      run: |
        NDK_DIR=~/.buildozer/android/platform/android-ndk-r25c
        if [ ! -d "$NDK_DIR" ]; then
          echo "Downloading NDK r25c..."
          wget https://dl.google.com/android/repository/android-ndk-r25c-linux.zip -O ndk.zip
          mkdir -p ~/.buildozer/android/platform
          unzip -q ndk.zip -d ~/.buildozer/android/platform
          rm ndk.zip
        fi

    - name: Build Go binary for Android
      run: |
        chmod +x build_go_android.sh
        go mod init ech-wk || true
        go get github.com/gorilla/websocket@v1.5.3
        go mod tidy
        ./build_go_android.sh

    - name: Build with Buildozer (ÊçïËé∑ÊâÄÊúâËæìÂá∫)
      id: build_step
      continue-on-error: true
      run: |
        echo "Starting Buildozer build..."
        # ‰ΩøÁî®ÊîπËøõÁöÑÈÖçÁΩÆÊñá‰ª∂
        cp improved_buildozer.spec buildozer.spec
        
        # ËøêË°åbuildozerÂπ∂ÊçïËé∑ÊâÄÊúâËæìÂá∫
        buildozer -v android debug 2>&1 | tee buildozer_build.log
        
        # Ê£ÄÊü•ÊûÑÂª∫ÊòØÂê¶ÊàêÂäü
        if [ $? -eq 0 ]; then
          echo "build_success=true" >> $GITHUB_OUTPUT
        else
          echo "build_success=false" >> $GITHUB_OUTPUT
        fi

    - name: Ultimate APK Rescue Mission (Â¢ûÂº∫Áâà)
      if: ${{ always() }}
      run: |
        echo "========================================"
        echo "üîç Ultimate APK Rescue Mission Started"
        echo "========================================"
        
        # ÂàõÂª∫ËæìÂá∫ÁõÆÂΩï
        mkdir -p rescued_apks
        found_apks=0
        
        # 1. ÊêúÁ¥¢ÊâÄÊúâÂèØËÉΩÁöÑAPK‰ΩçÁΩÆ
        echo "üìÅ Searching for APK files in all possible locations..."
        
        # ÊêúÁ¥¢.buildozerÁõÆÂΩï‰∏ãÁöÑÊâÄÊúâAPK
        find .buildozer -name "*.apk" -type f | while read -r apk_file; do
          echo "‚úÖ Found APK: $apk_file"
          cp "$apk_file" "rescued_apks/$(basename "$apk_file")"
          found_apks=$((found_apks + 1))
        done
        
        # ÊêúÁ¥¢È°πÁõÆÊ†πÁõÆÂΩï‰∏ãÁöÑAPK
        find . -maxdepth 5 -name "*.apk" -type f ! -path "./rescued_apks/*" | while read -r apk_file; do
          echo "‚úÖ Found APK: $apk_file"
          cp "$apk_file" "rescued_apks/$(basename "$apk_file")"
          found_apks=$((found_apks + 1))
        done
        
        # 2. Ê£ÄÊü•ÊòØÂê¶ÊâæÂà∞APK
        if [ $found_apks -gt 0 ]; then
          echo "üéâ Found $found_apks APK file(s)!"
          ls -la rescued_apks/
        else
          echo "‚ùå No APK files found in any location"
        fi
        
        # 3. Âç≥‰ΩøÊ≤°ÊúâÊâæÂà∞APKÔºå‰πüÂàõÂª∫‰∏Ä‰∏™Ê†áËÆ∞Êñá‰ª∂
        echo "Build completed at: $(date)" > rescued_apks/build_info.txt
        echo "Build success: ${{ steps.build_step.outputs.build_success }}" >> rescued_apks/build_info.txt
        
        # 4. Â§çÂà∂ÊûÑÂª∫Êó•Âøó
        if [ -f buildozer_build.log ]; then
          cp buildozer_build.log rescued_apks/
        fi
        
        echo "========================================"
        echo "üîç Ultimate APK Rescue Mission Completed"
        echo "========================================"

    - name: Upload Everything (ÊûÑÂª∫‰∫ßÁâ© + Êó•Âøó)
      if: ${{ always() }}
      uses: actions/upload-artifact@v4
      with:
        name: ech-wk-android-artifacts
        path: |
          rescued_apks/**/*
          buildozer_build.log
          buildozer.log
        retention-days: 14

    - name: Build Status Summary
      if: ${{ always() }}
      run: |
        echo "========================================"
        echo "üìä Build Status Summary"
        echo "========================================"
        echo "Build Success: ${{ steps.build_step.outputs.build_success }}"
        echo "APK Files Found: $(ls rescued_apks/*.apk 2>/dev/null | wc -l)"
        echo "========================================"
        
        # Â¶ÇÊûúÊûÑÂª∫Â§±Ë¥•‰ΩÜÊâæÂà∞‰∫ÜAPKÔºåÁªôÂá∫Ë≠¶Âëä
        if [ "${{ steps.build_step.outputs.build_success }}" = "false" ] && [ $(ls rescued_apks/*.apk 2>/dev/null | wc -l) -gt 0 ]; then
          echo "‚ö†Ô∏è WARNING: Build failed but APK files were found!"
          echo "‚ö†Ô∏è These APKs might be from a previous successful build"
        fi
