name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        
    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential ccache git libncurses5-dev libssl-dev libffi-dev python3-dev python3-pip \
                          libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev libsdl2-mixer-dev libjpeg-dev zlib1g-dev \
                          openjdk-17-jdk unzip wget curl
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython==3.0.0
        
    - name: Increase Git timeout
      run: |
        git config --global http.postBuffer 524288000
        git config --global http.timeout 300
        git config --global https.timeout 300
        
    - name: Initialize Go modules (if needed)
      run: |
        # 检查是否存在go.mod
        if [ ! -f "go.mod" ]; then
            echo "初始化Go模块..."
            go mod init github.com/byJoey/ech-wk
            go get github.com/gorilla/websocket@latest
        fi
        
        # 确保依赖完整
        go mod tidy
        
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/go/pkg/mod
          ~/.cache/go-build
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: Cross-compile Go code for arm-v7a
      run: |
        # 下载Android NDK（使用curl替代wget，增加重试）
        if [ ! -d "android-ndk-r25b" ]; then
            echo "下载Android NDK r25b..."
            curl -L --retry 5 --retry-delay 10 --max-time 300 \
              https://dl.google.com/android/repository/android-ndk-r25b-linux.zip \
              -o android-ndk-r25b-linux.zip
            unzip -q android-ndk-r25b-linux.zip
            rm -f android-ndk-r25b-linux.zip
        fi
        
        export ANDROID_NDK_HOME=$(pwd)/android-ndk-r25b
        
        # 设置交叉编译环境
        export CC=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang
        export CXX=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang++
        export GOOS=android
        export GOARCH=arm
        export GOARM=7
        export CGO_ENABLED=1
        
        # 编译ech-workers
        go build -o ech-workers ech-workers.go
        
        # 验证编译结果
        file ech-workers
        ls -la ech-workers
        
    - name: Cache Buildozer dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.buildozer
          .buildozer
          ~/.android
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-
          
    - name: Build Android APK with retries
      run: |
        # 增加网络超时设置
        export HTTP_TIMEOUT=300
        export HTTPS_TIMEOUT=300
        
        # 尝试构建，最多重试3次
        for i in 1 2 3; do
            echo "尝试构建第 $i 次..."
            if buildozer -v android debug; then
                echo "构建成功！"
                exit 0
            fi
            echo "构建失败，等待10秒后重试..."
            sleep 10
        done
        echo "所有尝试都失败了"
        exit 1
      
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-armv7a-apk
        path: bin/*.apk
        retention-days: 7
        
    - name: Create GitHub Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main' && success()
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
        name: Android Release ${{ github.sha }}
        tag_name: android-${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
