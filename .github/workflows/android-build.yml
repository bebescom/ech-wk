name: Build Android APK (Fix NDK Version)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.10 (Âº∫Âà∂ÁâàÊú¨)
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"
        architecture: "x64"
        cache: "pip"

    - name: Install Java 17 (Required for Gradle)
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y git zip unzip python3-pip \
          autoconf automake libtool pkg-config libgmp3-dev libmpfr-dev libmpc-dev \
          libssl-dev libncurses5-dev libncursesw5-dev libtinfo6 libltdl-dev \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev zlib1g-dev \
          libpython3-dev python3-dev libffi-dev

    - name: Clean ALL previous builds (ÂΩªÂ∫ïÊ∏ÖÁêÜ)
      run: |
        echo "Performing deep clean of previous builds..."
        # Ê∏ÖÁêÜ Buildozer ÁºìÂ≠ò
        rm -rf ~/.buildozer
        rm -rf .buildozer
        # Ê∏ÖÁêÜ Python ÁºìÂ≠ò
        rm -rf __pycache__
        rm -rf *.pyc
        # Ê∏ÖÁêÜÊûÑÂª∫ËæìÂá∫
        rm -rf bin/
        rm -rf dist/
        rm -rf build/
        # Ê∏ÖÁêÜ Go Áõ∏ÂÖ≥Êñá‰ª∂
        rm -rf go.mod go.sum
        # Ê∏ÖÁêÜ NDK Áõ∏ÂÖ≥Êñá‰ª∂
        rm -rf android-ndk-*
        # ÂàõÂª∫ÂøÖË¶ÅÁõÆÂΩï
        mkdir -p bin

    - name: Install Buildozer and dependencies (ÊåáÂÆöÁâàÊú¨)
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install cython==0.29.36
        pip install buildozer==1.5.0
        pip install python-for-android==2024.01.21

    - name: Install Android NDK r25c (Âº∫Âà∂ÁâàÊú¨)
      run: |
        echo "========================================"
        echo "üîß Installing Android NDK r25c (Âº∫Âà∂ÁâàÊú¨)"
        echo "========================================"
        
        # Á°Æ‰øù NDK ÁõÆÂΩï‰∏çÂ≠òÂú®
        rm -rf ~/.buildozer/android/platform/android-ndk-r25c
        rm -rf ~/.buildozer/android/platform/android-ndk-*
        
        # ÂàõÂª∫ NDK ÁõÆÂΩï
        mkdir -p ~/.buildozer/android/platform
        
        # ‰∏ãËΩΩÂπ∂ÂÆâË£Ö NDK r25c
        wget https://dl.google.com/android/repository/android-ndk-r25c-linux.zip -O ndk.zip
        unzip -q ndk.zip -d ~/.buildozer/android/platform
        rm ndk.zip
        
        # È™åËØÅ NDK ÂÆâË£Ö
        NDK_PATH=~/.buildozer/android/platform/android-ndk-r25c
        echo "‚úÖ NDK installed at: $NDK_PATH"
        echo "‚úÖ NDK version: $(grep -A 1 "Pkg.Revision" $NDK_PATH/source.properties | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+')"
        
        # ËÆæÁΩÆ NDK ÁéØÂ¢ÉÂèòÈáè
        echo "‚úÖ Setting NDK environment variables"
        echo "export ANDROID_NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
        echo "export NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
        echo "export PATH=$NDK_PATH:$PATH" >> $GITHUB_ENV

    - name: Build Go binary for Android
      run: |
        chmod +x build_go_android.sh
        go mod init ech-wk || true
        go get github.com/gorilla/websocket@v1.5.3
        go mod tidy
        ./build_go_android.sh

    - name: Fix buildozer.spec configuration (Áªü‰∏Ä NDK Âíå Python ÈÖçÁΩÆ)
      run: |
        echo "========================================"
        echo "üîß Fixing buildozer.spec configuration"
        echo "========================================"
        
        # ÂàõÂª∫‰∏¥Êó∂‰øÆÂ§çËÑöÊú¨
        cat > fix_buildozer_spec.py << 'EOF'
        import re
        import os
        
        # ËØªÂèñÂéüÂßãÈÖçÁΩÆÊñá‰ª∂
        with open('buildozer.spec', 'r') as f:
            content = f.read()
        
        # ‰øÆÂ§çÁ©∫ÂàóË°®ÈÖçÁΩÆ - Â∞Ü [] ÊõøÊç¢‰∏∫Á©∫Â≠óÁ¨¶‰∏≤
        content = re.sub(r'android\.manifest\.intent_filters = \[\]', 'android.manifest.intent_filters = ', content)
        content = re.sub(r'android\.add_java = \[\]', 'android.add_java = ', content)
        content = re.sub(r'android\.add_aars = \[\]', 'android.add_aars = ', content)
        content = re.sub(r'android\.add_libs = \[\]', 'android.add_libs = ', content)
        
        # Âº∫Âà∂ËÆæÁΩÆ Python 3.10 (Ë¶ÜÁõñ‰ªª‰ΩïÁé∞ÊúâÈÖçÁΩÆ)
        content = re.sub(r'python\.version = .*', 'python.version = 3.10', content)
        content = re.sub(r'requirements = .*', 'requirements = python3==3.10.13,kivy==2.3.0,pillow,requests', content)
        
        # Á°Æ‰øùÂåÖÂê´ÊâÄÊúâÂøÖË¶ÅÁöÑÊñá‰ª∂
        content = re.sub(r'source\.include_exts = .*', 'source.include_exts = py,kv,txt,bin,png,jpg,js,sh,go,exe,c,h,so', content)
        
        # Âº∫Âà∂Ê∑ªÂä† Python ÂÖ±‰∫´Â∫ìÈÖçÁΩÆ (Âç≥‰ΩøÂ∑≤Â≠òÂú®‰πüË¶ÜÁõñ)
        # È¶ñÂÖàÁßªÈô§‰ªª‰ΩïÁé∞ÊúâÁöÑ python_recipe ÈÖçÁΩÆ
        content = re.sub(r'^p4a\.python_recipe = .*$', '', content, flags=re.MULTILINE)
        # ÁÑ∂ÂêéÊ∑ªÂä†Êñ∞ÁöÑÈÖçÁΩÆ
        if 'p4a.python_recipe = python3crystax' not in content:
            content += '\n# Âº∫Âà∂ Python ÂÖ±‰∫´Â∫ìÈÖçÁΩÆ\np4a.python_recipe = python3crystax\n'
        
        # Âº∫Âà∂ËÆæÁΩÆ NDK ÁâàÊú¨
        content = re.sub(r'android\.ndk = .*', 'android.ndk = r25c', content)
        
        # ‰øùÂ≠ò‰øÆÂ§çÂêéÁöÑÈÖçÁΩÆÊñá‰ª∂
        with open('buildozer.spec.fixed', 'w') as f:
            f.write(content)
        
        print("‚úÖ buildozer.spec Â∑≤‰øÆÂ§ç")
        print("‚úÖ Âº∫Âà∂ËÆæÁΩÆ Python 3.10")
        print("‚úÖ Âº∫Âà∂Ê∑ªÂä† Python ÂÖ±‰∫´Â∫ìÈÖçÁΩÆ")
        print("‚úÖ Âº∫Âà∂ËÆæÁΩÆ NDK r25c")
        
        # ÊòæÁ§∫‰øÆÂ§çÂêéÁöÑÈÖçÁΩÆÊëòË¶Å
        print("\nüìã ‰øÆÂ§çÂêéÁöÑÈÖçÁΩÆÊëòË¶Å:")
        for line in content.split('\n'):
            if line.startswith('python.version') or line.startswith('requirements') or line.startswith('p4a.python_recipe') or line.startswith('android.ndk'):
                print(f"  {line}")
        EOF
        
        # ËøêË°å‰øÆÂ§çËÑöÊú¨
        python fix_buildozer_spec.py
        
        # ‰ΩøÁî®‰øÆÂ§çÂêéÁöÑÈÖçÁΩÆÊñá‰ª∂
        cp buildozer.spec.fixed buildozer.spec
        echo "‚úÖ ‰ΩøÁî®‰øÆÂ§çÂêéÁöÑ buildozer.spec"

    - name: Build with Buildozer (Áªü‰∏ÄÁâàÊú¨ÈÖçÁΩÆ)
      id: build_step
      continue-on-error: true
      run: |
        echo "========================================"
        echo "üî® Starting Buildozer build with UNIFIED versions"
        echo "========================================"
        
        # Á°Æ‰øù‰ΩøÁî® Java 17
        export JAVA_HOME=${{ steps.setup-java.outputs.path }}
        export PATH=$JAVA_HOME/bin:$PATH
        
        # Âº∫Âà∂‰ΩøÁî® Python 3.10
        export PATH="/opt/hostedtoolcache/Python/3.10.19/x64/bin:$PATH"
        
        # Á°Æ‰øù‰ΩøÁî®Ê≠£Á°ÆÁöÑ NDK
        export ANDROID_NDK_HOME=${{ env.ANDROID_NDK_HOME }}
        export NDK_HOME=${{ env.NDK_HOME }}
        export PATH=$ANDROID_NDK_HOME:$PATH
        
        # È™åËØÅÊâÄÊúâÁâàÊú¨
        echo "========================================"
        echo "üîç ÁâàÊú¨È™åËØÅ"
        echo "========================================"
        echo "Python version:"
        python --version
        echo "Java version:"
        java -version 2>&1 | head -n 1
        echo "Javac version:"
        javac -version 2>&1
        echo "Buildozer version:"
        buildozer --version
        echo "NDK version:"
        ndk-build --version 2>&1 | head -n 1
        echo "NDK path:"
        echo $ANDROID_NDK_HOME
        echo "========================================"
        
        # ËøêË°å buildozer Âπ∂ÊçïËé∑ÊâÄÊúâËæìÂá∫
        buildozer -v android debug 2>&1 | tee buildozer_build.log
        
        # Ê£ÄÊü•ÊûÑÂª∫ÊòØÂê¶ÊàêÂäü
        if [ $? -eq 0 ]; then
          echo "build_success=true" >> $GITHUB_OUTPUT
        else
          echo "build_success=false" >> $GITHUB_OUTPUT
        fi

    - name: Â¢ûÂº∫ÂûãË∞ÉËØï (ÊûÑÂª∫ÂâçÂêéÈÉΩÊâßË°å)
      run: |
        echo "========================================"
        echo "üîç Â¢ûÂº∫ÂûãË∞ÉËØï‰ø°ÊÅØ"
        echo "========================================"
        
        # Ê£ÄÊü•Á≥ªÁªüÁéØÂ¢É
        echo "üìå Á≥ªÁªüÁéØÂ¢ÉÂèòÈáè:"
        env | grep -E "(PYTHON|JAVA|NDK|ANDROID)" | head -20
        
        # Ê£ÄÊü• Python ÊûÑÂª∫ÁõÆÂΩï
        PYTHON_DIR=".buildozer/android/platform/build-armeabi-v7a/build/other_builds/python3"
        echo -e "\nüìå Python build directory: $PYTHON_DIR"
        
        if [ -d "$PYTHON_DIR" ]; then
          echo "‚úÖ Python build directory exists"
          echo "Directory contents:"
          ls -la "$PYTHON_DIR"
          
          # Ê£ÄÊü• Python ÁâàÊú¨ÁõÆÂΩï
          echo -e "\nüìå Python version directories:"
          find "$PYTHON_DIR" -maxdepth 1 -type d | grep -E "(python3|3\.)"
          
          # Ê£ÄÊü• Python ÂÖ±‰∫´Â∫ì
          echo -e "\nüìå Python shared library files:"
          find "$PYTHON_DIR" -name "libpython*.so" -o -name "python_shared.*" | head -20
        else
          echo "‚ùå Python build directory does not exist"
        fi
        
        # Ê£ÄÊü• NDK ÈÖçÁΩÆ
        echo -e "\nüìå NDK configuration:"
        find ~/.buildozer/android/platform -name "android-ndk-*"
        ls -la ~/.buildozer/android/platform/ | grep ndk

    - name: Ultimate APK Rescue Mission
      if: ${{ always() }}
      run: |
        echo "========================================"
        echo "üîç Ultimate APK Rescue Mission Started"
        echo "========================================"
        
        # ÂàõÂª∫ËæìÂá∫ÁõÆÂΩï
        mkdir -p rescued_apks
        found_apks=0
        
        # ÊêúÁ¥¢ÊâÄÊúâÂèØËÉΩÁöÑ APK ‰ΩçÁΩÆ
        echo "üìÅ Searching for APK files in all possible locations..."
        
        # ÊêúÁ¥¢ .buildozer ÁõÆÂΩï
        if [ -d ".buildozer" ]; then
          find .buildozer -name "*.apk" -type f | while read -r apk_file; do
            echo "‚úÖ Found APK: $apk_file"
            cp "$apk_file" "rescued_apks/$(basename "$apk_file")"
            found_apks=$((found_apks + 1))
          done
        fi
        
        # ÊêúÁ¥¢È°πÁõÆÊ†πÁõÆÂΩï
        find . -maxdepth 5 -name "*.apk" -type f ! -path "./rescued_apks/*" | while read -r apk_file; do
          echo "‚úÖ Found APK: $apk_file"
          cp "$apk_file" "rescued_apks/$(basename "$apk_file")"
          found_apks=$((found_apks + 1))
        done
        
        # Ê£ÄÊü•ÊòØÂê¶ÊâæÂà∞ APK
        if [ $found_apks -gt 0 ]; then
          echo "üéâ Found $found_apks APK file(s)!"
          ls -la rescued_apks/
        else
          echo "‚ùå No APK files found"
        fi
        
        # ÂàõÂª∫ÊûÑÂª∫‰ø°ÊÅØ
        echo "Build completed at: $(date)" > rescued_apks/build_info.txt
        echo "Build success: ${{ steps.build_step.outputs.build_success }}" >> rescued_apks/build_info.txt
        echo "Java version used: $(java -version 2>&1 | head -n 1)" >> rescued_apks/build_info.txt
        echo "Python version used: $(python --version 2>&1)" >> rescued_apks/build_info.txt
        echo "NDK version used: $(ndk-build --version 2>&1 | head -n 1 | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+')" >> rescued_apks/build_info.txt
        echo "Go binary built: $(ls ech-workers 2>/dev/null && echo "Yes" || echo "No")" >> rescued_apks/build_info.txt
        
        # Â§çÂà∂Êó•ÂøóÊñá‰ª∂
        cp buildozer_build.log rescued_apks/ 2>/dev/null || true
        cp buildozer.log rescued_apks/ 2>/dev/null || true
        cp buildozer.spec rescued_apks/buildozer.spec.used 2>/dev/null || true

    - name: Upload Everything (ÊûÑÂª∫‰∫ßÁâ© + Êó•Âøó)
      if: ${{ always() }}
      uses: actions/upload-artifact@v4
      with:
        name: ech-wk-android-artifacts
        path: |
          rescued_apks/**/*
          buildozer_build.log
          buildozer.log
        retention-days: 14

    - name: Build Status Summary
      if: ${{ always() }}
      run: |
        echo "========================================"
        echo "üìä Build Status Summary"
        echo "========================================"
        echo "Build Success: ${{ steps.build_step.outputs.build_success }}"
        echo "APK Files Found: $(ls rescued_apks/*.apk 2>/dev/null | wc -l)"
        echo "Java Version: $(java -version 2>&1 | head -n 1)"
        echo "Python Version: $(python --version 2>&1)"
        echo "NDK Version: $(ndk-build --version 2>&1 | head -n 1 | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+')"
        echo "Go Binary Built: $(ls ech-workers 2>/dev/null && echo "‚úÖ Yes" || echo "‚ùå No")"
        echo "========================================"
