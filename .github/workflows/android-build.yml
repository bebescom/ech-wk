name: Build Android APK (Fix Directory Check)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        
    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential ccache git libncurses5-dev libssl-dev libffi-dev python3-dev python3-pip \
                          libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev libsdl2-mixer-dev libjpeg-dev zlib1g-dev \
                          openjdk-17-jdk unzip wget curl p7zip-full
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython==3.0.0
        
    - name: Initialize Go modules (if needed)
      run: |
        # 检查是否存在go.mod
        if [ ! -f "go.mod" ]; then
            echo "初始化Go模块..."
            go mod init github.com/byJoey/ech-wk
            go get github.com/gorilla/websocket@latest
        fi
        
        # 确保依赖完整
        go mod tidy
        
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/go/pkg/mod
          ~/.cache/go-build
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: System diagnostic information
      run: |
        echo "=== 系统信息 ==="
        uname -a
        echo "=== 磁盘空间 ==="
        df -h
        echo "=== 内存信息 ==="
        free -h
        
    - name: Manually download and install Android components with fixed directory check
      run: |
        set -x  # 启用调试输出
        
        # 创建必要的目录
        echo "=== 创建目录结构 ==="
        mkdir -p ~/.buildozer/android/platform
        mkdir -p ~/.buildozer/cache
        mkdir -p ~/.buildozer/logs
        
        # 1. 下载并安装Android NDK r25b
        echo "=== 手动下载Android NDK r25b ==="
        ndk_zip="android-ndk-r25b-linux.zip"
        ndk_url="https://dl.google.com/android/repository/android-ndk-r25b-linux.zip"
        target_dir=~/.buildozer/android/platform/
        
        # 检查是否已下载
        if [ -f "$ndk_zip" ]; then
            echo "✅ NDK压缩包已存在"
            ls -la "$ndk_zip"
        else
            echo "正在下载NDK: $ndk_url"
            # 使用详细模式下载，显示进度和错误
            curl -L --verbose --retry 20 --retry-delay 30 --max-time 1200 \
              --progress-bar --show-error \
              "$ndk_url" -o "$ndk_zip"
            
            # 验证下载结果
            if [ $? -ne 0 ]; then
                echo "❌ NDK下载失败"
                exit 1
            fi
        fi
        
        # 验证文件大小
        file_size=$(stat -c%s "$ndk_zip")
        echo "下载的文件大小: $file_size 字节"
        
        # 正确的最小预期大小：约500MB (524288000字节)
        min_expected_size=500000000
        
        if [ $file_size -lt $min_expected_size ]; then
            echo "❌ NDK文件太小，可能下载不完整"
            echo "   实际大小: $file_size 字节"
            echo "   最小预期: $min_expected_size 字节"
            ls -la "$ndk_zip"
            exit 1
        else
            echo "✅ NDK文件大小验证通过"
        fi
        
        # 解压NDK - 修复的核心部分
        echo "=== 解压NDK ==="
        
        # 先清理可能存在的旧文件
        echo "清理目标目录: $target_dir"
        rm -rf "$target_dir"*
        
        # 创建干净的目标目录
        mkdir -p "$target_dir"
        
        # 使用7z解压并显示详细信息
        echo "正在使用7z解压NDK到: $target_dir"
        7z x -y "$ndk_zip" -o"$target_dir"
        
        # 验证解压结果
        if [ $? -ne 0 ]; then
            echo "❌ 7z解压NDK失败，尝试使用unzip..."
            unzip -o -v "$ndk_zip" -d "$target_dir"
            
            if [ $? -ne 0 ]; then
                echo "❌ NDK解压失败"
                exit 1
            fi
        fi
        
        # 列出解压后的所有内容（关键调试信息）
        echo "=== 解压后的目录内容 ==="
        ls -la "$target_dir"
        echo "=== 子目录列表 ==="
        find "$target_dir" -type d | head -20
        
        # 智能检测NDK目录 - 修复的核心逻辑
        echo "=== 智能检测NDK目录 ==="
        
        # 查找所有可能的NDK目录
        ndk_dirs=$(find "$target_dir" -maxdepth 1 -type d -name "android-ndk-*" | sort)
        
        if [ -z "$ndk_dirs" ]; then
            echo "❌ 未找到NDK目录"
            echo "目标目录内容:"
            ls -la "$target_dir"
            exit 1
        fi
        
        # 选择第一个NDK目录
        selected_ndk_dir=$(echo "$ndk_dirs" | head -n 1)
        echo "找到NDK目录: $selected_ndk_dir"
        
        # 验证目录内容
        if [ -f "$selected_ndk_dir/source.properties" ]; then
            echo "✅ NDK目录验证通过"
            echo "NDK版本信息:"
            cat "$selected_ndk_dir/source.properties" 2>/dev/null
        else
            echo "❌ NDK目录不完整"
            ls -la "$selected_ndk_dir"
            exit 1
        fi
        
        # 2. 下载并安装Android SDK
        echo "=== 手动下载Android SDK ==="
        sdk_zip="commandlinetools-linux-6514223_latest.zip"
        sdk_url="https://dl.google.com/android/repository/$sdk_zip"
        
        if [ ! -f "$sdk_zip" ]; then
            echo "正在下载SDK: $sdk_url"
            curl -L --verbose --retry 15 --retry-delay 20 --max-time 900 \
              --progress-bar --show-error \
              "$sdk_url" -o "$sdk_zip"
            
            if [ $? -ne 0 ]; then
                echo "❌ SDK下载失败"
                exit 1
            fi
        fi
        
        # 解压SDK
        sdk_dir="$target_dir/android-sdk"
        if [ ! -d "$sdk_dir" ]; then
            mkdir -p "$sdk_dir"
            7z x -y "$sdk_zip" -o"$sdk_dir"
            
            if [ $? -ne 0 ]; then
                unzip -o -v "$sdk_zip" -d "$sdk_dir"
                
                if [ $? -ne 0 ]; then
                    echo "❌ SDK解压失败"
                    exit 1
                fi
            fi
        fi
        
        # 3. 下载并安装Apache ANT
        echo "=== 手动下载Apache ANT ==="
        ant_tar="apache-ant-1.9.4-bin.tar.gz"
        ant_url="https://archive.apache.org/dist/ant/binaries/$ant_tar"
        
        if [ ! -f "$ant_tar" ]; then
            echo "正在下载ANT: $ant_url"
            curl -L --verbose --retry 10 --retry-delay 15 --max-time 600 \
              --progress-bar --show-error \
              "$ant_url" -o "$ant_tar"
            
            if [ $? -ne 0 ]; then
                echo "❌ ANT下载失败"
                exit 1
            fi
        fi
        
        # 解压ANT
        ant_dir="$target_dir/apache-ant-1.9.4"
        if [ ! -d "$ant_dir" ]; then
            tar xzf -v "$ant_tar" -C "$target_dir"
            
            if [ $? -ne 0 ]; then
                echo "❌ ANT解压失败"
                exit 1
            fi
        fi
        
        # 设置环境变量 - 使用智能检测到的NDK目录
        export ANDROID_NDK_HOME="$selected_ndk_dir"
        export ANDROID_SDK_ROOT="$sdk_dir"
        export ANT_HOME="$ant_dir"
        export PATH="$PATH:$ANT_HOME/bin"
        
        # 将环境变量写入文件，供后续步骤使用
        echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANT_HOME=$ANT_HOME" >> $GITHUB_ENV
        echo "PATH=$PATH" >> $GITHUB_ENV
        
        # 显示安装摘要
        echo "=== 安装摘要 ==="
        echo "NDK路径: $ANDROID_NDK_HOME"
        echo "SDK路径: $ANDROID_SDK_ROOT"
        echo "ANT路径: $ANT_HOME"
        echo "=== 安装完成 ==="
        
    - name: Cross-compile Go code for arm-v7a
      run: |
        # 设置交叉编译环境
        export CC=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang
        export CXX=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang++
        export GOOS=android
        export GOARCH=arm
        export GOARM=7
        export CGO_ENABLED=1
        
        # 编译ech-workers
        go build -o ech-workers ech-workers.go
        
        # 验证编译结果
        file ech-workers
        ls -la ech-workers
        
    - name: Cache Buildozer dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.buildozer
          .buildozer
        key: ${{ runner.os }}-buildozer-fix-dir-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-fix-dir-
          
    - name: Patch Buildozer to skip NDK download
      run: |
        echo "=== 修补Buildozer以跳过NDK下载 ==="
        
        # 找到Buildozer的Android目标文件
        buildozer_targets_dir=$(python -c "import buildozer.targets.android; print(buildozer.targets.android.__file__)")
        buildozer_targets_dir=$(dirname "$buildozer_targets_dir")
        
        echo "Buildozer目标文件目录: $buildozer_targets_dir"
        
        # 创建一个补丁来跳过NDK下载
        cat > patch_buildozer.py << 'EOF'
        import buildozer.targets.android
        import os
        
        # 保存原始的_install_android_ndk方法
        original_install_android_ndk = buildozer.targets.android.AndroidTarget._install_android_ndk
        
        def patched_install_android_ndk(self):
            """
            修补后的_install_android_ndk方法，跳过下载
            """
            # 智能检测NDK目录
            target_dir = os.path.expanduser("~/.buildozer/android/platform/")
            ndk_dirs = [d for d in os.listdir(target_dir) if d.startswith('android-ndk-') and os.path.isdir(os.path.join(target_dir, d))]
            
            if ndk_dirs:
                ndk_path = os.path.join(target_dir, ndk_dirs[0])
                self.buildozer.info(f"✅ NDK已手动安装在: {ndk_path}")
                self.buildozer.global_platform_dir = target_dir
                return
            
            # 如果NDK不存在，调用原始方法
            self.buildozer.warning("⚠️ NDK未找到，使用原始下载方法")
            original_install_android_ndk(self)
        
        # 替换原始方法
        buildozer.targets.android.AndroidTarget._install_android_ndk = patched_install_android_ndk
        print("✅ Buildozer已成功修补，将跳过NDK下载")
        EOF
        
        # 运行补丁
        python patch_buildozer.py
        
    - name: Build Android APK
      run: |
        echo "=== 开始构建Android APK ==="
        
        # 再次确认环境变量
        echo "NDK路径: $ANDROID_NDK_HOME"
        echo "SDK路径: $ANDROID_SDK_ROOT"
        echo "ANT路径: $ANT_HOME"
        
        # 验证所有组件都已安装
        if [ ! -d "$ANDROID_NDK_HOME" ]; then
            echo "❌ NDK目录不存在: $ANDROID_NDK_HOME"
            ls -la ~/.buildozer/android/platform/
            exit 1
        fi
        
        if [ ! -d "$ANDROID_SDK_ROOT" ]; then
            echo "❌ SDK目录不存在: $ANDROID_SDK_ROOT"
            exit 1
        fi
        
        if [ ! -d "$ANT_HOME" ]; then
            echo "❌ ANT目录不存在: $ANT_HOME"
            exit 1
        fi
        
        # 显示更多调试信息
        echo "=== 详细调试信息 ==="
        echo "Buildozer版本:"
        buildozer --version
        
        echo "=== 运行Buildozer ==="
        # 使用详细日志级别运行Buildozer
        buildozer -v android debug 2>&1 | tee buildozer.log
        
        # 检查是否生成了APK
        if [ -f "bin/*.apk" ]; then
            echo "✅ APK构建成功"
            ls -la bin/
        else
            echo "❌ APK构建失败"
            # 显示最后200行日志
            echo "=== 最后200行构建日志 ==="
            tail -n 200 buildozer.log
            exit 1
        fi
      
    - name: Upload debug logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-directory-fix-logs
        path: |
          buildozer.log
          ~/.buildozer/logs/*
        retention-days: 14
        
    - name: Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: android-armv7a-apk
        path: bin/*.apk
        retention-days: 30
