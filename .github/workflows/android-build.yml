name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
        
    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential ccache git libncurses5-dev libssl-dev libffi-dev python3-dev python3-pip \
                          libsdl2-dev libsdl2-image-dev libsdl2-ttf-dev libsdl2-mixer-dev libjpeg-dev zlib1g-dev \
                          openjdk-17-jdk unzip wget
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython==3.0.0
        
    - name: Download Android NDK for Go cross-compilation
      run: |
        wget https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
        unzip -q android-ndk-r25b-linux.zip
        export ANDROID_NDK_HOME=$(pwd)/android-ndk-r25b
        echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
        
    - name: Initialize Go modules (if needed)
      run: |
        # 检查是否存在go.mod
        if [ ! -f "go.mod" ]; then
            echo "初始化Go模块..."
            go mod init github.com/byJoey/ech-wk
            go get github.com/gorilla/websocket@latest
        fi
        
        # 确保依赖完整
        go mod tidy
        
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/go/pkg/mod
          ~/.cache/go-build
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: Cross-compile Go code for arm-v7a
      run: |
        # 设置环境变量
        export CC=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang
        export CXX=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang++
        export GOOS=android
        export GOARCH=arm
        export GOARM=7
        export CGO_ENABLED=1
        
        # 编译ech-workers
        go build -o ech-workers ech-workers.go
        
        # 验证编译结果
        file ech-workers
        ls -la ech-workers
        
    - name: Cache Buildozer dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.buildozer
          .buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-
          
    - name: Build Android APK
      run: |
        # 运行Buildozer
        buildozer -v android debug
      
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-armv7a-apk
        path: bin/*.apk
        retention-days: 7
        
    - name: Create GitHub Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
        name: Android Release ${{ github.sha }}
        tag_name: android-${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
